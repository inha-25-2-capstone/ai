name: AI Server CI/CD

on:
  push:
    branches: [ main, develop ]  # develop도 추가
  pull_request:
    branches: [ main, develop ]  # feature → develop, develop → main 모두 커버

jobs:
  # 1. 코드 품질 검사 (Linting & Formatting)
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-quality-

    - name: Install quality tools
      run: |
        pip install --upgrade pip
        pip install flake8 black isort mypy bandit safety

    - name: Check code formatting with black
      run: |
        black --check --diff app/ main.py
      continue-on-error: false  # 실패 시 CI 중단

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff app/ main.py
      continue-on-error: false

    - name: Lint with flake8
      run: |
        # E501: line too long (120자로 완화)
        # W503: line break before binary operator (black 스타일과 충돌)
        # E203: whitespace before ':' (black 스타일과 충돌)
        flake8 app/ main.py \
          --count \
          --max-line-length=120 \
          --extend-ignore=W503,E203 \
          --statistics \
          --show-source
      continue-on-error: false

    - name: Type check with mypy
      run: |
        mypy app/ main.py \
          --ignore-missing-imports \
          --no-strict-optional \
          --warn-unused-ignores
      continue-on-error: true  # 타입 힌트 추가 중이므로 경고만

    - name: Security check with bandit
      run: |
        bandit -r app/ main.py \
          -f json \
          -o bandit-report.json \
          --severity-level medium
      continue-on-error: true  # 보안 이슈는 경고만

    - name: Dependency security check
      run: |
        safety check --json
      continue-on-error: true

  # 2. 테스트 (여러 Python 버전)
  test:
    runs-on: ubuntu-latest
    needs: code-quality  # 코드 품질 통과 후 실행

    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: Check Python syntax
      run: |
        python -m py_compile main.py
        find app -name "*.py" -exec python -m py_compile {} \;

    - name: Run tests with coverage
      run: |
        if [ -d "tests" ]; then
          pytest tests/ -v \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=50
        else
          echo "⚠️ No tests found. Please add tests in 'tests/' directory."
          exit 0
        fi
      env:
        PYTHONPATH: ${{ github.workspace }}
      continue-on-error: true  # 테스트가 없어도 통과 (개발 초기)

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.10'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

    - name: Test server startup
      run: |
        timeout 10s python main.py || code=$?;
        if [[ $code -ne 124 && $code -ne 0 ]]; then
          echo "❌ Server failed to start (exit code: $code)"
          exit $code
        fi
        echo "✅ Server started successfully"
      env:
        PORT: 5000
        CORS_ORIGINS: "*"

  # 3. Docker 빌드 테스트 (develop, main 브랜치만)
  docker-build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' && (github.base_ref == 'develop' || github.base_ref == 'main')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Check if Dockerfile exists
      id: dockerfile-check
      run: |
        if [ -f "Dockerfile" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Build Docker image (test only)
      if: steps.dockerfile-check.outputs.exists == 'true'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ai-server:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker container
      if: steps.dockerfile-check.outputs.exists == 'true'
      run: |
        docker run -d --name ai-server-test -p 5000:5000 ai-server:test
        sleep 5
        curl -f http://localhost:5000/api/health || exit 1
        docker stop ai-server-test
        echo "✅ Docker container test passed"

  # 4. PR 정보 코멘트
  comment-pr:
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: checks } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.payload.pull_request.head.sha
          });

          const conclusion = checks.check_runs.every(run =>
            run.conclusion === 'success' || run.conclusion === 'skipped'
          ) ? '✅ All checks passed!' : '⚠️ Some checks failed';

          const comment = `## CI/CD Results

          ${conclusion}

          ### Checks completed:
          - Code quality (formatting, linting, type checking)
          - Unit tests (Python 3.8, 3.9, 3.10)
          - Server startup test
          ${context.payload.pull_request.base.ref !== 'main' ? '' : '- Docker build test'}

          **Branch**: \`${context.payload.pull_request.head.ref}\` → \`${context.payload.pull_request.base.ref}\`
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
